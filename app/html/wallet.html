<!doctype>
<html>

<head>
<script type="text/javascript" src="../vendor/web3.js/dist/web3.js"></script>
<script type="text/javascript" src="../js/abi/namereg.abi.js"></script>
<script type="text/javascript" src="../js/abi/oracle.abi.js"></script>
<script type="text/javascript" src="../js/abi/wallet.abi.js"></script>
<script type="text/javascript" src="../js/lib/web3Helper.js"></script>
<script type="text/javascript" src="../js/lib/nameregHelper.js"></script>
<script type="text/javascript">
    console.log("loading js");
    /*global getWeb3*/

    var web3;
    var nameregHelper;

    function onload() {
        console.log("onload");
        web3 = getWeb3();
        nameregHelper = new NameregHelper(web3);
        
        uiWeb3(web3);
        
        setup();
    }
    
    //===============================================
    // setup
    //===============================================
    function setup() {
        nameregHelper.getAddressOf('Oracle').then(function(address) {
            setOracle(address);
            return nameregHelper.getAddressOf('Wallet');
        }, abort).then( function(address) {
            setWallet(address);
            return setWalletParams();
        }, abort).then( function(result) {
            console.log( "#########################################" + result);
        }, abort);
    }
    
    //=======================================
    // Oracle
    //=======================================
    var oracleInstance;
    var oracleNotify;
    function setOracle(address) {
        console.log( "setOracle:" + address);
        var abi = oracleAbi();
        oracleInstance = web3.eth.contract(abi).at(address);
        
        // watch for Notify
        oracleNotify = oracleInstance.Notify();
        oracleNotify.watch( function(err, result) {
            var TAG = "oracleNotify.watch: ";
            if (err) {
                console.log(TAG, "ERROR", err);
                return;
            }
            console.log(TAG, "Notify", result.args);
        });
    }
    
    //=======================================
    // Wallet
    //=======================================
    var walletInstance;
    var walletFeedback;
    function setWallet(address) {
        console.log( "setWallet:", address);
        var abi = walletAbi();
        walletInstance = web3.eth.contract(abi).at(address);
        
        // watch for Feedback
        walletFeedback = walletInstance.Feedback();
        walletFeedback.watch( function(err, result) {
            var TAG = "Feedback.watch: ";
            if (err) {
                console.log(TAG, "ERROR", err);
                return;
            }
            console.log(TAG, "Feedback", result.args);
            uiWalletFeedback(result.args.text);
        });
        
        console.log( "setWallet: setOracle", oracleInstance.address);
        walletInstance.setOracle(oracleInstance.address); // FIXME - not waiting to be mined
    }
    
    function walletSetPhone(phone) {
        walletInstance.setPhone(phone);
    }
    
    function walletSpend(amount) {
        walletInstance.spend(amount);
    }
    
    function setWalletParams() {
        return mine( walletInstance.setOracle, oracleInstance.address ).then( function(result){
            console.log( "2222 " + result);
            return ("done 2222");
        }, abort);
    }
    
    function mine( func, arg ) {
        return new Promise( function(resolve, reject) {
            func(arg, function(error, tx) {
                resolve( tx );
            });
        });
    }

    
    function abort(error) {
        console.log( "ABORT", error);
        uiError(error);
        if (error instanceof Error)
            throw error;
        throw new Error(error);
    }   
    
    //=======================================
    // UI
    //=======================================
    function uiWeb3(web3) {
        //console.log(web3);
        document.getElementById('uiSandbox').innerText =  web3.currentProvider.host;
        document.getElementById('uiStatus').innerText = "connected";
    }
    
    function uiError(error) {
        document.getElementById('status').innerText = error.toString();
    }
    
    function uiWalletFeedback(message) {
        console.log(message);
        document.getElementById('walletStatus').innerText = message;
    }
    
    //=======================================
    // events
    //=======================================
    function onClickPhone() {
        var value = document.getElementById('phoneValue').value;
        walletSetPhone(value);
    }
    
    function onClickSpend() {
        var value = document.getElementById('spendValue').value;
        walletSpend(value);
    }

</script>
</head>
<body onload="onload()">
    <h1>Wallet</h1>
    <div id="uiWeb3">
        <table>
            <tr>
                <td>Sandbox: </td>
                <td>
                    <div id="uiSandbox">---</div>
                </td>
            </tr>
            <tr>
                <td>Status: </td>
                <td>
                    <div id="uiStatus">---</div>
                </td>
            </tr>
        </table>
    </div>
    </br>
    
    <div id="uiWallet">
        <table>
            <tr>
                <td><button type="button" onClick="onClickPhone();">Set Phone</button></td>
                <td><input type="text" id="phoneValue"/ value="+14158105251"></td>
            </tr>
            <tr>
                <td><button type="button" onClick="onClickSpend();">Spend</button></td>
                <td><input type="text" id="spendValue" value="1234"/></td>
            </tr>
            <tr>
                <td>Message</td>
                <td><div id="walletStatus">---</div></td>
            </tr>
        </table>
    </div>

</body>
</html>
